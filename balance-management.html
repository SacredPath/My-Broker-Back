<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Management - Admin</title>
    <link rel="stylesheet" href="backoffice.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Balance Management</h1>
            <div class="header-actions">
                <button onclick="refreshBalances()" class="btn btn-primary">Refresh</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </header>

        <main>
            <!-- Search and Filter -->
            <section class="search-section">
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="Search by email or user ID..." class="form-control">
                    <select id="currencyFilter" class="form-control">
                        <option value="">All Currencies</option>
                        <option value="USD">USD</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                    </select>
                    <button onclick="searchBalances()" class="btn btn-primary">Search</button>
                </div>
            </section>

            <!-- Balance Table -->
            <section class="balance-table-section">
                <h2>All User Balances</h2>
                <div class="table-container">
                    <table id="balanceTable" class="data-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Currency</th>
                                <th>Amount</th>
                                <th>USD Value</th>
                                <th>Available</th>
                                <th>Locked</th>
                                <th>Total</th>
                                <th>Type</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="balanceTableBody">
                            <tr>
                                <td colspan="12" class="text-center">Loading balances...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Balance Modal -->
    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User Balance</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>User ID:</label>
                    <input type="text" id="editUserId" readonly class="form-control">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="text" id="editEmail" readonly class="form-control">
                </div>
                <div class="form-group">
                    <label>Currency:</label>
                    <input type="text" id="editCurrency" readonly class="form-control">
                </div>
                
                <div class="form-section">
                    <h4>User Balance</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount:</label>
                            <input type="number" id="editAmount" step="0.01" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>USD Value:</label>
                            <input type="number" id="editUsdValue" step="0.01" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>Wallet Balance</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Available:</label>
                            <input type="number" id="editAvailable" step="0.01" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Locked:</label>
                            <input type="number" id="editLocked" step="0.01" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Total:</label>
                            <input type="number" id="editTotal" step="0.01" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveBalanceChanges()" class="btn btn-primary">Save Changes</button>
                <button onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script src="env.js"></script>
    <script src="api.js"></script>
    <script>
        let allBalances = [];
        let currentEditingBalance = null;

        // Load balances on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBalances();
        });

        async function loadBalances() {
            try {
                document.getElementById('balanceTableBody').innerHTML = '<tr><td colspan="12" class="text-center">Loading balances...</td></tr>';
                
                allBalances = await window.API.getAllUserBalances();
                displayBalances(allBalances);
            } catch (error) {
                console.error('Failed to load balances:', error);
                document.getElementById('balanceTableBody').innerHTML = '<tr><td colspan="12" class="text-center error">Failed to load balances: ' + error.message + '</td></tr>';
            }
        }

        function displayBalances(balances) {
            const tbody = document.getElementById('balanceTableBody');
            
            if (!balances || balances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No balances found</td></tr>';
                return;
            }

            tbody.innerHTML = balances.map(balance => `
                <tr>
                    <td>${balance.user_id}</td>
                    <td>${balance.user_email}</td>
                    <td>${balance.user_name}</td>
                    <td>${balance.currency}</td>
                    <td>${balance.amount !== null ? parseFloat(balance.amount).toFixed(2) : '-'}</td>
                    <td>${balance.usd_value !== null ? parseFloat(balance.usd_value).toFixed(2) : '-'}</td>
                    <td>${balance.available !== null ? parseFloat(balance.available).toFixed(2) : '-'}</td>
                    <td>${balance.locked !== null ? parseFloat(balance.locked).toFixed(2) : '-'}</td>
                    <td>${balance.total !== null ? parseFloat(balance.total).toFixed(2) : '-'}</td>
                    <td><span class="badge badge-${balance.type}">${balance.type}</span></td>
                    <td>${new Date(balance.updated_at).toLocaleString()}</td>
                    <td>
                        <button onclick="editBalance('${balance.user_id}', '${balance.currency}')" class="btn btn-sm btn-primary">Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function searchBalances() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const currencyFilter = document.getElementById('currencyFilter').value;
            
            let filtered = allBalances;
            
            if (searchTerm) {
                filtered = filtered.filter(balance => 
                    balance.user_email.toLowerCase().includes(searchTerm) ||
                    balance.user_id.toLowerCase().includes(searchTerm) ||
                    balance.user_name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (currencyFilter) {
                filtered = filtered.filter(balance => balance.currency === currencyFilter);
            }
            
            displayBalances(filtered);
        }

        function editBalance(userId, currency) {
            const balance = allBalances.find(b => b.user_id === userId && b.currency === currency);
            if (!balance) return;

            currentEditingBalance = balance;
            
            document.getElementById('editUserId').value = balance.user_id;
            document.getElementById('editEmail').value = balance.user_email;
            document.getElementById('editCurrency').value = balance.currency;
            
            document.getElementById('editAmount').value = balance.amount !== null ? balance.amount : '';
            document.getElementById('editUsdValue').value = balance.usd_value !== null ? balance.usd_value : '';
            document.getElementById('editAvailable').value = balance.available !== null ? balance.available : '';
            document.getElementById('editLocked').value = balance.locked !== null ? balance.locked : '';
            document.getElementById('editTotal').value = balance.total !== null ? balance.total : '';
            
            document.getElementById('editBalanceModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editBalanceModal').style.display = 'none';
            currentEditingBalance = null;
        }

        async function saveBalanceChanges() {
            if (!currentEditingBalance) return;

            const updates = {};
            
            // Only include fields that have values
            const amount = document.getElementById('editAmount').value;
            const usdValue = document.getElementById('editUsdValue').value;
            const available = document.getElementById('editAvailable').value;
            const locked = document.getElementById('editLocked').value;
            const total = document.getElementById('editTotal').value;
            
            if (amount !== '') updates.amount = parseFloat(amount);
            if (usdValue !== '') updates.usd_value = parseFloat(usdValue);
            if (available !== '') updates.available = parseFloat(available);
            if (locked !== '') updates.locked = parseFloat(locked);
            if (total !== '') updates.total = parseFloat(total);

            try {
                await window.API.updateUserBalance(currentEditingBalance.user_id, currentEditingBalance.currency, updates);
                alert('Balance updated successfully!');
                closeEditModal();
                loadBalances(); // Refresh the table
            } catch (error) {
                console.error('Failed to update balance:', error);
                alert('Failed to update balance: ' + error.message);
            }
        }

        function refreshBalances() {
            loadBalances();
        }

        function logout() {
            window.API.signOut();
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editBalanceModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
